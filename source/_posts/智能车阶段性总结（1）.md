---
title: 智能车阶段性总结（1）
copyright: true
tags:
  - 智能车比赛
  - NXP
  - 项目实战
categories:
  - NXP智能车比赛
abbrlink: 8cbc
date: 2019-03-05 12:59:21
---

{% note %}
前言：从组队到现在已经过去一个多月了，寒假这么长时间算是储备知识的时候，到处寻找资料避免不了做很多无用功，当时我就决定在开始做车的时候把整个过程总结记录下来。不仅是前人栽树后人乘凉，也是对自己的一个阶段性总结，记录一下自己的学习路线和成长过程，也方便团队内部分享交流。开学已经两周了，期间开过几次会，因为大家在智能车方面的知识有限，很多前期的工作必须要谨慎处理，不然可能会影响后面的进展。昨天K60刚到货，引脚分配也是修改了第三次。以后配件可能会陆续到货，第一阶段也就到这里了。
{% endnote %}

<!--more-->

## 智能车设计方案

由于安徽大学已经连续参加了好几届智能车比赛，有了很多经验和总结。某些软件和硬件策咯已经很成熟了，所以也不必花太多时间去制定设计方案，可以参考近几届学长的方案，必要的地方做些改动即可。下面就对我们采用的方案进行一下整理，也梳理一下我的学习路线。

### 硬件电路

#### 电机驱动

根据学长的建议我们应该选择C车模也就是双电机车模，所以电机驱动板也要是双电机驱动。安徽大学的电机驱动板已经做的比较成熟了，使用的是英飞凌的经典驱动组合IR2104+IR7843组成的驱动电路。原理图如下所示：
![IR2104+IR7843驱动原理图](https://i.loli.net/2019/03/05/5c7e529d73155.jpg)
从IR2104出来的信号加在mos管的栅极，高电平使得mos管导通，低电平截止。

> 以下资料可帮助理解电机驱动

- [电机驱动原理简介（来自学长）](https://gitee.com/erhuoyan/NXP/blob/master/%E7%94%B5%E6%9C%BA%E9%A9%B1%E5%8A%A8%E5%8E%9F%E7%90%86%E7%AE%80%E4%BB%8B.md)
- [安徽大学电机驱动参考](https://gitee.com/erhuoyan/NXP/tree/master/%E7%94%B5%E6%9C%BA%E9%A9%B1%E5%8A%A8%E5%8F%82%E8%80%83%E8%AE%BE%E8%AE%A1)
- [常用电机驱动原理](https://wenku.baidu.com/view/637b225d0b1c59eef8c7b490.html?from=search)

#### 信号采集电路

因为我们是小白四轮组，今年不再限制传感器数量，但是对车身长度和高度进行了限制，所以要完成比赛必须要同时使用使用摄像头和电感两种传感器。

电磁传感器需要设计采集电路，摄像头不需要设计采集电路。由于ADC模块引脚有限，而且摄像头模块会用到大量引脚，所以在前几届八路采集电路基础上删掉两路改为六路信号采集。不仅如此，在研究12届电磁单车程序的时候发现他们实际只用了三路AD采集，具体原因可能要到后期调试的时候再深究了。

> 参考12届电磁信号采集板,改为六路即可

- [安徽大学电磁电路参考](https://gitee.com/erhuoyan/NXP/tree/master/%E7%AC%AC12%E5%B1%8A%E7%94%B5%E7%A3%81%E7%BB%84%E5%8D%95%E8%BD%A6%E2%80%94%E2%80%94B%E8%BD%A6)

#### 主控板

近两届安大智能车比赛都是使用龙邱的MK60DN512VL10，K60由很多系列,由于学长的推荐我们便没在核心板的选择上费心思考。

![MK60DN512VLL10](https://i.loli.net/2019/03/06/5c7ec0b0870d9.jpg)

第一块主板建议采用直插式，在确定主板硬件没有bug后可以改为贴片式：

| 对比  |直插式 |贴片式 |
|:----:|:-----:|:----:|
| 原理图|![直插式原理图](https://i.loli.net/2019/03/05/5c7e91fad66c4.png) |![贴片式原理图](https://i.loli.net/2019/03/05/5c7e92341a766.png) |
|  PCB| ![PCB直插式](https://i.loli.net/2019/03/05/5c7e927303d35.png) | ![贴片式PCB](https://i.loli.net/2019/03/05/5c7e92b5b5f73.png)|

由对比可以看出贴片式的难度较大，而且K60的焊接还是比较困难的，但是贴片K60价格会便宜一些，所占空间也会更小。后期如果有时间和兴趣可以挑战一下。

主控板的设计方案也是有参考的，关键就是引脚分配了。前面已经说了今年要分出6个ADC引脚用作电磁信号采集，而且使用C车模有两个电机，也就需要4路pwm，同时需要两个编码器。

{% note danger %}
每个FTM模块只能设置一种频率。所以电机，舵机，编码器要分别占用一个FTM模块。
{% endnote %}

所以K60的三个FTM模块要这样分配：FTM0模块分出4个引脚用来输出PWM控制电机，FTM1控制舵机，而FTM2只能控制一个编码器，另一个编码器就需要用到低功耗计数器模块，引脚是固定的，为PTC5。

摄像头的引脚也是固定的，蓝牙引脚常为PTE24和PTE25,主板上还要有12864液晶接口占用5个普通IO口,蜂鸣器，拨码开关，按键都需要普通IO口。参考11届摄像头C车：

- [安徽大学主板电路参考](https://gitee.com/erhuoyan/NXP/tree/master/%E7%AC%AC11%E5%B1%8A%E6%91%84%E5%83%8F%E5%A4%B4%E5%8F%8C%E8%BD%A6%E2%80%94%E2%80%94C%E8%BD%A6)

##### 引脚分配方案：

![引脚分配](https://i.loli.net/2019/03/05/5c7e9adf77b1f.png)

{% note danger %}
注意考虑J-LINK的引脚，这些引脚被占用不知道下载会不会出错，还是不要占用的好。
{% endnote %}

学长给的一个文档统计了K60的AD和FTM模块所有引脚，但是后来发现那是144pin的引脚统计，有些在100pin的K60上就找不到。

### 软件编程

#### 底层库

K60是ARM的一种，编程不像之前C51和arduino那样。但是现在已经有很多开源的K60底层库，使用这些库就有点类似arduino编程一样调用库函数就行。近几年安大采用的是LPLD的开源底层库,官方已经不再维护了。可以直接clone我的[码云](https://gitee.com/erhuoyan/NXP)仓库,里边还有LPLD官方**例程**和**教程**，都是改过bug的。

#### 必备软件

- Altium Designer 绘制原理图和PCB。建议使用16或17版本。
- IAR K60编程软件

#### 初试K60

> 昨天学姐买的K60和J-LINK到货了，我的任务就是测试。我打算测试一下它的串口通信功能。

我下载了官方例程中的第一个程序，用串口在电脑上打印HelloWold。使用J-link需要先安装J-link驱动，虽然安装IAR时已经安装了J-link驱动，但是为了让驱动和硬件版本一致，还是使用硬件配套的驱动较好。

程序编译，下载都没有错误。但是遇到一个问题是，串口调试助手检索不到串口，在电脑的设备管理器中也找不到串口设备的存在。当时弄了好久，最后换了一个UART例程，这才发现，程序初始化PTA14,PTA15为UART引脚，但是J-link并没有连接这两个引脚。这才意识到自己先入为主了。在使用C51和arduino的时候，下载端口同时也是串口，K60并不是这样。我找到之前做遥控车时用过的USB转TTL模块，连接发送端和接收端，安装usb转串口驱动后连接电脑就能在设备管理器中发现串口了。

![串口](https://i.loli.net/2019/03/06/5c7ead944064d.png)

下面再使用IAR下载程序，就可以使用串口助手进行通信了。明天再试试蓝牙主从机的功能。

{% note warning %}
IAR在下载程序的时候有两种模式，一种是RAM模式，只能将程序下载到RAM中，断电后程序丢失。第二种是FLASH模式，将程序下载到单片机的FLASH中，断电后程序不会丢失。我做的测试仅在RAM模式下进行。
{% endnote %}

### 思考感悟

万事开头难，刚开始的时候也是一头雾水，只有不停的找资料学习才慢慢对智能车有更清晰的了解。但是没有好的指引通仅靠自己摸索很耗时间。我也是做了很多无用功，导致现在思路混乱，写这一系列博客也是回顾自己的探索过程，将有用的信息总结下来，让自己思路更清晰。如果由后来人看的话也能作为指导书，避免走弯路，把时间都用在正确的地方。上面已经对我所得信息做了总结，下面做一些心得感悟，也是总结一下自己的思考路线。

#### 对主控板的一些思考

- MCU

虽然安大一直使用的是K60DN512VLL10。实际上野火做了性能测试:

![性能测试](https://i.loli.net/2019/03/05/5c7e737b02176.png)

FX系列要比DN系列性能快，K60的FX/FN浮点性能是DN的5倍多。由于我们使用的是LPLD库，已经不再更新，虽然最后一个版本中添加了对F系列的支持，但没有前人的经验，时间紧迫下还是不敢尝试。保守起见还是使用DN512，但是100pin真的有点老了，尤其是在分配引脚的时候，感觉到100pin对于摄像头和电感同时使用有点吃力，尽管最后勉强够用后期不知道会不会负载过大而出错。所以我认为这一届最优的选择应该是144pin的MK60DN512VLQ10做主控。

#### ADC引脚的一些疑问

其实ADC功能引脚还是挺多的，但是有些都带有特殊功能.

![PTE](https://i.loli.net/2019/03/05/5c7e9cf9dc3fd.png)

这些SE应该代表精度，在学长的程序里定义的精度为10，所以我一开始尽量寻找SE10以上的AD引脚，甚至不下心把J-LINK的引脚占用了。但是后来发现初始化程序里的PTB0和PTB1分别是SE8和SE9然后我就放弃纠结这个问题了：

![ADC](https://i.loli.net/2019/03/06/5c7e9f3027999.png)

![PTB](https://i.loli.net/2019/03/06/5c7e9e959a8de.png)

还有些引脚看着比较特别：

![AD](https://i.loli.net/2019/03/06/5c7ea264cd4da.png)

以后再研究有什么特别的地方。目前只知道与DMA和PDB有关。

#### 对底层库选择的建议

由于安大前几届都是使用LPLD底层库，但是这个库官方已经不在更新了，而且教程极少，只有一个官方文档，虽然使用简单，但是学起来较困难，例程也不是很多。对K60F系列的支持性未知。因为现在时间比较紧，没有时间再去学一个新的底层库。

K60的开源底层库有很多，其中用的比较多的是山外的底层库。山外有其自主经营的智能车论坛，建议下一届考虑一下使用山外的底层库，配有文档教程和视频教程。配合F系列高性能的MCU。说不定会有一个突破。

## 附

> 附上一些前文提到的链接

- 本队仓库：[GitHub](https://github.com/erhuoyan/NXP_car)
- 资料仓库：[码云](https://gitee.com/erhuoyan/NXP)
- AD：[视频教程](https://www.pcbbar.com/thread-6847-1-1.html)
- 团队协作：[Git教程](https://www.liaoxuefeng.com/wiki/0013739516305929606dd18361248578c67b8067c8c017b000)
- 智能车论坛：
  - [智能车制作](http://www.znczz.com/home.php?mod=space&do=notice&view=system):官方论坛，可以下载往届技术报告
  - [山外论坛](http://www.vcan123.com/forum.php?mod=collection&action=view&ctid=26):原野火论坛，可以学习野火底层库
